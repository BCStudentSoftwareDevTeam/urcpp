{% extends "base.html" %}

{% block body %}

<form>
  <div class = "row">
    <div class = "col-md-3">
      Project Title
    </div>
    <div class = "col-md-6">
      Title: <input name = "title" id = "title" type = "text" />
    </div>
    <div class = "row">
      Program: <select name = "program" id = "program"> </select>
    </div>
    <div class = "row"> 
      Duration: <select name = "duration" id = "duration"> </select>
    </div>
    <div class = "row">
      Start Date: <input name = "startDate" id = "startDate" type = "text"  />
    </div>
  </div>
</form>

<div class = "row">
  <input id = "submit" type = "button" value = "Submit" onClick = "submitData();" />
</div>

<!-- JQuery Init -->
<script type = "text/javascript">
  $(function() {
    $( "#startDate" ).datepicker();
  });
   /* global urcpp */
  var api = urcpp('v1');

</script>

<!-- Submit data to server -->
<script type = "text/javascript">
   /* global api, username, formToObj, show */
  var submitData = function () {
    var obj = formToObj(document.querySelector("form"));
    console.log(obj);
    api.set.start(username, obj, show); 
  };
</script>

<!-- Loading data from the server -->
<script type = "text/javascript">
  /* global api, username */
  
  var show = function (d) {
    console.log (d);
    $("#echo").text(JSON.stringify (d));
  };

  // This function sets the project title field
  var setTitleAndStartDate = function (data) {
    // console.log(JSON.stringify(data));
    if ("project" in data) {
      $("#title").val(data.project.title);
      $("#startDate").val(data.project.startDate);
    }
  };
  // This API call asks the server for the project title.
  api.projects.getProject (username, setTitleAndStartDate);
  
  var setOptions = function (element, options) {
    var $el = $("#" + element);
    $el.empty(); // remove old options
    $.each(
      options, 
      function (value,key) {
        $el.append($("<option></option>")
           .attr("value", value).text(key));
      }
    );  
  }
  
  var setProgram = function (data) {
    var programs = data.programs;
    // console.log(JSON.stringify(programs));

    var options = {};
    for (var ndx = 0; ndx < programs.length ; ndx++ ) {
      var prog = programs[ndx];
      console.log("Name: " + prog.name + " ID: " + prog.pID);
      options[prog.pID] = prog.name;
    }
    
    setOptions ("program", options);
  };
  
  api.programs.getAll(setProgram);
  
  var setDuration = function (data) {
    var durations = data.durations;
    
    var options = {};
    for (var ndx = 0; ndx < durations.length ; ndx++ ) {
      var dur = durations[ndx];
      options[dur] = dur + " weeks";
    }
   
    setOptions("duration", options);
  };
  
  api.projects.getPossibleDurations(setDuration);
  
  var setDate = function (data) {
    // console.log(JSON.stringify(data));
    if ("startDate" in data) {
      $("#startDate").val(data.project.startDate);
    }
  }
</script>

{% endblock %}