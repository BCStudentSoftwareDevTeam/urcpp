{% extends "base.html" %}

{% block body %}

<style>
</style>

<h1>URCPP Project Basics</h1>

<p>
  Your project submission will require you to provide:
</p>

<ol>
  <li> Project Basics (this page) </li>
  <li> BNumbers for collaborators (if any) </li>
  <li> A project budget & number of students </li>
  <li> A project narrative (.docx or PDF) </li>
  <li> Something else? </li>
</ol>

<p>
  After you are finished, any project collaborators will need to login and submit their CVs as well. At that point, your submission will be complete.  
</p>

<form class = "form-horizontal well">
  <div class = "form-group">
    <label for="title" class = "col-sm-2 control-label">Project Title </label>
    <div class = "col-sm-8">
      <input name = "title" id = "title" type = "text" class="form-control"/>
    </div>
  </div>
  
  <div class = "form-group">
    <label for = "program" class = "col-sm-2 control-label">Program </label>
    <div class = "col-sm-8">
      <select name = "program" id = "program" class="form-control"> </select>
    </div>
  </div>
  
  <div class = "form-group"> 
    <label for = "duration" class = "col-sm-2 control-label">Duration </label>
    <div class = "col-sm-8">
      <select name = "duration" id = "duration" class="form-control"> </select>  
    </div>
  </div>
  
  <div class = "form-group">
    <label for = "startDate" class = "col-sm-2 control-label">Start Date </label>
    <div class = "col-sm-8">
      <input name = "startDate" id = "startDate" type = "text"  class="form-control"/>
    </div>
  </div>

  <div class = "form-group"  >
    <div class = "col-sm-offset-8 col-sm-2" 
         id = "submitButton"
         style = "display: none;">
      <button id = "submit" 
              type = "button" 
              class="btn btn-block btn-primary"
              onClick = "submitData();"
              class = "form-control"
              />
        Submit
      </button>
    </div>
  </div>
</form>
  
<!-- JQuery Init -->
<script type = "text/javascript">
  $(function() {
    $( "#startDate" ).datepicker();
  });
   /* global urcpp */
  var api = urcpp('v1');

</script>

<!-- Submit data to server -->
<script type = "text/javascript">
   /* global api, username, formToObj, show */
  var submitData = function () {
    var obj = formToObj(document.querySelector("form"));
    console.log("Sending data to server: " + JSON.stringify(obj) + "\n\n");
    api.set.start(username, obj, function (data) { console.log (data); } ); 
    api.go();
  };
</script>

<!-- Loading data from the server -->
<script type = "text/javascript">
  /* global api, username */

  // This function sets the project title field
  var setTitleAndStartDate = function (data) {
    // console.log(JSON.stringify(data));
    if ("project" in data) {
      console.log("Using project to set things: " + data);
      
      $("#title").val(data.project.title);
      $("#startDate").val(data.project.startDate);
      $("#duration").val(data.project.duration);
    }
  };

  var setOptions = function (element, options) {
    var $el = $("#" + element);
    $el.empty(); // remove old options
    $.each(
      options, 
      function (value,key) {
        $el.append($("<option></option>")
           .attr("value", value).text(key));
      }
    );  
  }
  
  var setProgram = function (data) {
    var programs = data.programs;
    // console.log(JSON.stringify(programs));

    var options = {};
    for (var ndx = 0; ndx < programs.length ; ndx++ ) {
      var prog = programs[ndx];
      console.log("Name: " + prog.name + " ID: " + prog.pID);
      options[prog.pID] = prog.name;
    }
    
    setOptions ("program", options);
  };
  
  var setFacultyProgram = function (data) {
    console.log("Using faculty to set things: " + JSON.stringify(data));
    console.log("\n");
    if (data.faculty.programID.pID) {
      var index = parseInt(data.faculty.programID.pID);
      console.log("Index for Program: " + index)
      $("#program").val(index);
    } else {
      $("#program").val(0); 
    }
  };
  
  var setDuration = function (data) {
    var durations = data.durations;
    
    var options = {};
    for (var ndx = 0; ndx < durations.length ; ndx++ ) {
      var dur = durations[ndx];
      options[dur] = dur + " weeks";
    }
   
    setOptions("duration", options);
  };
  
  var setDate = function (data) {
    // console.log(JSON.stringify(data));
    if ("startDate" in data) {
      $("#startDate").val(data.project.startDate);
    }
  };
  
  var showHidden = 
    function (element) {
      return { go: function () {
                    $("#" + element).show(); 
              }};
    };
    
  $(document).ready(function () {
    // API calls happen in-order.
    // First, we queue up the actions we want to take.
    api.programs.getAll(setProgram);
    api.projects.getPossibleDurations(setDuration);
    api.projects.get(username, setTitleAndStartDate);
    api.faculty.get(username, setFacultyProgram);
    api.enqueue (showHidden("submitButton"));
    // Then, we set them all in motion.
    api.go();
  });
  
</script>

{% endblock %}